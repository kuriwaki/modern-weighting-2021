---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# An Introduction to Modern Weighting (2021 Workshop)

Shiro Kuriwaki

<!-- badges: start -->
<!-- badges: end -->



## Setup

Download this repo as a Rstudio Project (From Remote Repository, Github, `"kuriwaki/modern-weighting-workshop-2021"`).

Load libraries

```{r, message=FALSE}
library(tidyverse)
library(scales)

library(survey)
library(autumn)
library(lme4)
```


Read in data as

```{r}
poll <- read_rds("data/poll.rds")
pop_micro <- read_rds("data/pop_microdata.rds")
```




# Poststratification

Q: What is the distributon of education in the sample? In the population?

```{r}
poll %>% count(educ) %>% mutate(frac = percent(n / sum(n), accuracy = 1))
pop_micro %>% count(educ) %>% mutate(frac = percent(n / sum(n), accuracy = 1))

```


Q: What are the weights that correct for this imbalance?

```{r}
edu_tgt <- pop_micro %>% count(educ) %>% transmute(educ, pop_frac = n / sum(n))

poll_strat <- poll %>% 
  count(educ) %>% 
  mutate(samp_frac = n / sum(n)) %>% 
  left_join(edu_tgt, by = "educ") %>% 
  mutate(weight0 = pop_frac / samp_frac)

poll_wt <- poll %>% 
  left_join(poll_strat, by = "educ")

poll_wt %>% 
  count(educ, wt = weight0) %>% 
  mutate(wt_frac = n / sum(n))
```


Q: Extension: do the same reweighting but for education and race.

```{r}
xtabs(~ as_factor(educ) + as_factor(race), pop_micro) %>% 
  addmargins()
```


# Raking

Q: What is the distribution of race and education in the survey. 

Now suppose you did NOT know the population _joint_ distribution of race x education, but you knew the _marginals_. Suppose that

* White: 70%
* Black: 12%
* Hispanic: 8%
* Asian: 4%
* Other 6%

and


* HS or Less (1): 40%
* Some College (2): 35%
* 4-Year (3): 15%
* Post-grad (4): 10%


```{r}
target_rake <- list(
  race = c(`1` = 0.70, `2` = 0.12, `3` = 0.08, `4` = 0.04, `5` = 0.06),
  educ = c(`1` = 0.40, `2` = 0.35, `3` = 0.15, `4` = 0.10)
)

poll_rake <- harvest(poll,  target_rake, weight_column = "rake_weight")
```


```{r cces_rake_weights, echo = FALSE}
with(poll_rake, plot(weight, rake_weight, bty = "n", pch = 19, cex = 0.5, xlab = "CCES weights"))
```


Q: What are some issues with doing poststratiifcation everywhere?

# Increased Variance Due to Weighting / Design Effect

Mean Square Error formula


Q: What do you need to compute the MSE (or RMSE) of an estimate? What are the components?


Q: Does weighting tend to increase or decrease the standard error of the estimator? The effective sample size? The design effect? Why?



Kish's design effect

```{r}
rwt <- poll_rake$rake_weight

sum(rwt)^2 / sum(rwt^2)

nrow(poll_rake) / (sum(rwt)^2 / sum(rwt^2))

var(rwt)

design_effect(rwt)
```



# MRP

```{r}
poll_fct <- poll %>% 
  mutate(educ = as_factor(educ), race = as_factor(race))

tgt_fct <- pop_micro %>% 
  mutate(educ = as_factor(educ), race = as_factor(race)) %>% 
  count(educ, race)
```


Many cells problem

```{r}
fit_logit <- glm(Y ~ educ*race, data = poll_fct, family = binomial)


cells_Ypred <- tgt_fct %>% 
  mutate(Ypred = predict(fit_logit, ., type = "response"))

cells_Ypred
```


```{r}
cells_Ypred %>% 
  summarize(Ypred = weighted.mean(Ypred, w = n))
```


Shrinkage


# Propensity Score (IPW) vs. Balancing Score

Links to Causal Inference

Coarsened Exact Matching

Balance Test Fallacy

Entropy Balancing / CBPS



# References

- Andrew Gelman. [2007](http://www.stat.columbia.edu/~gelman/research/published/STS226.pdf). "Struggles with Survey Weighting and
Regression Modeling", _Statistical Science_
- Kosuke Imai, Gary King, Elizabeth A Stuart. [2008](https://imai.fas.harvard.edu/research/files/matchse.pdf). "Misunderstandings between experimentalists and observationalists about causal inference", _JRSS A._
- Kosuke Imai, Marc Ratkovic. [2014](https://imai.fas.harvard.edu/research/files/CBPS.pdf).  "Covariate balancing propensity score", _JRSS B_.
- Gary King. [2007](https://www.youtube.com/watch?v=rBv39pK1iEs). "Why Propensity Scores Should Not Be Used for Matching", _Methods Colloquium Talk_. (Article with Rich Nielsen).
- Jens Hainmueller. [2012](https://web.stanford.edu/~jhain/Paper/PA2012.pdf). "Entropy Balancing for Causal Effects: A Multivariate Reweighting Method to Produce Balanced Samples in Observational Studies". _Political Analysis_
